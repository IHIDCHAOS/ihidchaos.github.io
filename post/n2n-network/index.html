<!DOCTYPE html>
<html>
  <head lang="zh">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
<meta content="telephone=no" name="format-detection"/>
<meta name="renderer" content="webkit">
<meta name="description" content="温故而知新">
<meta http-equiv="Access-Control-Allow-Origin" content="*">

<title>N2N异地组网实战 | 郭玉超</title>
<link href="https://ihidchaos.github.io/styles/main.css" type="text/css" rel="stylesheet"/>
<link rel="stylesheet" href="//cdn.bootcss.com/KaTeX/0.10.2/katex.min.css"/>
<script src="//cdn.bootcss.com/KaTeX/0.10.2/katex.min.js"></script>
<script src="//cdn.bootcss.com/KaTeX/0.10.2/contrib/auto-render.min.js"></script>
<script type="text/javascript" src="https://ihidchaos.github.io/media/scripts/jquery.js"></script>
<script type="text/javascript" src="https://ihidchaos.github.io/media/scripts/jquery.pjax.min.js"></script>
<script type="text/javascript" src="https://ihidchaos.github.io/media/scripts/basic.js"></script>
<script type="text/javascript" src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script async type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script async type="text/javascript" src="https://ihidchaos.github.io/media/scripts/search.js"></script>
<script type="text/javascript">
$(document).pjax('a[target!=_blank]', '#pjax-container', {
	fragment: '#pjax-container',
	timeout: 5000,
	cache: false
});
$(document).on('pjax:complete', function(){  	
	pjax();
});

$(window).on('popstate.pjax', function () {
	pjax();
})

function pjax() {
	$.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");

	if (("#gitalk-container").length > 0 ) {
	$('#mememe').attr('src','//source.unsplash.com/800x400/?arts,weather?'+Math.random());
	$.getScript("//cdn.bootcss.com/KaTeX/0.10.2/katex.min.js");
	$.getScript("//cdn.bootcss.com/KaTeX/0.10.2/contrib/auto-render.min.js");
	$('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
    	});
	}
}
</script>

  </head>

  <body>
     <div class="header">
      <div class="logo_title">
		  
        <div class="title animated fadeInDown"><img id="img1" style="display:inline-block;" src="https://ihidchaos.github.io/images/avatar.png"/>
<script>
var r = 0;
    window.onload = function(){
        var current = 0;
        document.getElementById('img1').onclick = function(){
            current = (current+90)%360;
            this.style.transform = 'rotate('+current+'deg)';
        }
    };
</script>
          <h1 title="郭玉超" class="weaklink"><a  href="/">郭玉超</a>

          </h1>

          <div class="navbar weaklink">
            <div class="normal_nav">

<div class="bitcron_nav_container">


  <div class="bitcron_nav">
    <div class="mixed_site_nav_wrap site_nav_wrap">
		
      <ul class="mixed_site_nav site_nav sm sm-base">
	  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >首页</a>
  </li>
  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >归档</a>
  </li>
  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >标签</a>
  </li>
  
 
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >关于</a>
  </li>
  
 
 <li>

      </ul>
	  

      <div class="clear clear_nav_inline_end"></div>
<div class="search">
    <i class="search-icon fa fa-search search-start"></i>
    <input type="text" class="search-input" placeholder="Searching..." />
    <i class="search-icon fa fa-refresh search-clear"></i>
	<div class="search-results"></div>
</div>
    </div>

  </div>



  <div class="clear clear_nav_end"></div>

</div>

            </div>
			
			<div class="hamberger"><i class="fa fa-bars"></i>
<i class="fa fa-times"></i>

			</div>

          </div>

        </div>

      </div>

      <div class="hidden_nav animated fadeInDown">

<div class="bitcron_nav_container">


  <div class="bitcron_nav">
    <div class="mixed_site_nav_wrap site_nav_wrap">
      <ul class="mixed_site_nav site_nav sm sm-base">
	
  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/" class="selected active current nav__item" >首页</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/archives" class="selected active current nav__item" >归档</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/tags" class="selected active current nav__item" >标签</a>

  </li>


  <li><a id="d2ef19af68cc211e98f8a0242ac110003" href="/post/about" class="selected active current nav__item" >关于</a>

  </li>




      </ul>

      <div class="clear clear_nav_inline_end"></div>
    </div>

  </div>



  <div class="clear clear_nav_end"></div>

</div>

      </div>

    </div>

<style type="text/css">
.search {
    position: relative;
    height: 30px;
    text-align: right;
    line-height: 30px;
    padding-right: 10px;
}

.search .search-icon {
    float: right;
    height: 100%;
    margin: 0 10px;
    line-height: 30px;
    cursor: pointer;
    user-select: none;
}

.search .search-input {
    float: right;
    width: 30%;
    height: 30px;
    line-height: 30px;
    margin: 0;
    border: 2px solid #ddd;
    border-radius: 10px;
    box-sizing: border-box;
}

.search .search-clear {
    display: none;
}

.search .search-results {
    display: block;
    z-index: 1000;
    position: absolute;
    top: 30px;
    right: 50px;
    width: 50%;
    max-height: 400px;
    overflow: auto;
    text-align: left;
    border-radius: 5px;
    box-shadow: 0 .3rem .5rem #333;
}

.search .search-results .result-item {
    color: #000;
    margin: 5px;
    padding: 3px;
    border-radius: 3px;
    cursor: pointer;
}

</style>

    <div class="main" id="pjax-container">
      <div class="main-inner">


<div class="content">






  <div class="post_page" >

<div class="post">
  <div class="post_title sm_margin">
    <h2><a>N2N异地组网实战</a>



    </h2>
  </div>
  
<script>
function lan(){
	if (document.getElementById("lan").innerText == "繁"){
		var s=document.getElementById("tongwenlet_cn");
		if(s != null){
		document.body.removeChild(s);
		}
		var s = document.createElement("script");
		s.language = "javascript";
		s.type = "text/javascript";
		s.src = "https://git.oschina.net/runningcheese/JiathisQR.js/raw/master/bookmarklet_tw.js";
		s.id = "tongwenlet_cn";
		document.body.appendChild(s);
		document.getElementById("lan").innerHTML = "简"
	}
	else if(document.getElementById("lan").innerText == "簡"){
		var s=document.getElementById("tongwenlet_cn");
		if(s != null){
		document.body.removeChild(s);
		}
		var s = document.createElement("script");
		s.language = "javascript";
		s.type = "text/javascript";
		s.src = "https://git.oschina.net/runningcheese/JiathisQR.js/raw/master/bookmarklet_cn.js";
		s.id = "tongwenlet_cn";
		document.body.appendChild(s);
		document.getElementById("lan").innerHTML = "繁"
		}
}

function change(){	
    var rand = Math.random()*1+1;
    var num = window.getComputedStyle(document.getElementsByName("show")[0],undefined).fontSize;
	num = num.slice(0,-2); 
    document.getElementById("show").style.fontSize = num - rand +'px';
}
</script>

  <div class="post_details">
    <div class="info"><i class="fa fa-clock-o"></i>
<span class="date_info">2019-06-06</span>
<i class="fa fa-eye"></i>

<span class="date_info"><span id="busuanzi_value_page_pv"></span> Views</span>

<i class="fa fa-bookmark-o"></i>
<span class="tags_info weaklink">
	
	<a href="https://ihidchaos.github.io/tag/network/" class="tag">网络</a>


</span>
<span>5 min read</span>
&nbsp
&nbsp
<i class="fa fa-share"></i>
<a title="QR code" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://ihidchaos.github.io/post/n2n-network/"><i class="fa fa-qrcode"></i></a>
<a title="qq share" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://ihidchaos.github.io/post/n2n-network/&sharesource=qzone&title=N2N异地组网实战&pics=https://blog.blinkstar.cn/images/avatar.png&summary=&lt;h2 id=&#34;用户需求&#34;&gt;用户需求&lt;/h2&gt;
&lt;p&gt;技术人员在公司本地即可实现像访问本地网络（例如192.168.1.1）一样来访问异地网络，从而能够对远端路由网关下面的PLC等设备进行维护与调试。&lt;/p&gt;
"><i class="fa fa-qq"></i></a>
<a title="weibo share" target="_blank" href="https://service.weibo.com/share/share.php?url=https://ihidchaos.github.io/post/n2n-network/&sharesource=weibo&title=N2N异地组网实战 + " - " + &lt;h2 id=&#34;用户需求&#34;&gt;用户需求&lt;/h2&gt;
&lt;p&gt;技术人员在公司本地即可实现像访问本地网络（例如192.168.1.1）一样来访问异地网络，从而能够对远端路由网关下面的PLC等设备进行维护与调试。&lt;/p&gt;
&pic="https://blog.blinkstar.cn/images/avatar.png"><i class="fa fa-weibo"></i></a>
&nbsp
&nbsp
<a id="daxiao" href="javascript:void(0);" onclick="change();" title="调整字体大小"><i class="fa fa-font"></i></a>
&nbsp
&nbsp
<a id="lan" href="javascript:void(0);" onclick="lan();" title="调整简繁体">繁</a>
</div>
  </div>

  <div class="post_content markdown">
  &nbsp
  <img id="mememe" src="//source.unsplash.com/800x400/?arts,weather">
    <div name="show" id="show">
	<p class="md_block"><span class="md_line md_line_start md_line_end"><h2 id="用户需求">用户需求</h2>
<p>技术人员在公司本地即可实现像访问本地网络（例如192.168.1.1）一样来访问异地网络，从而能够对远端路由网关下面的PLC等设备进行维护与调试。</p>
<!-- more -->
<h2 id="拓扑结构">拓扑结构</h2>
<figure data-type="image" tabindex="1"><a href="https://imgchr.com/i/EbdVFH"><img src="https://s2.ax1x.com/2019/05/16/EbdVFH.png" alt="EbdVFH.png" loading="lazy"></a></figure>
<h2 id="工作原理">工作原理</h2>
<p>在这里简单介绍一下N2N的原理。如下图所示，</p>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2019/05/16/5cdd2ba339f7e20954.png" alt="n2n_yuanli.png" loading="lazy"></figure>
<p>n2n是一个二层架构的VPN网络，服务器端中心节点（<code>SuperNode</code>） 用于交流，相当于一个”路由器”， 而边界节点（<code>EdgeNode</code>）就是每一台在网络中（可以是内网中）的主机。EdgeNode通过和SuperNode沟通后，进入某个组的“局域网”，当有同“局域网”（同组）的主机进行连接时，两台主机就直接连接起来，就像局域网内的两台主机一样。在两台主机连接后， SuperNode任务完成，EdgeNode断开中心节点，实现P2P的加密通信。因此SuperNode并不参与两台主机间直接通信,。只是起到媒人的作用。</p>
<h2 id="解决过程">解决过程</h2>
<h3 id="本地pc">本地PC</h3>
<p>首先我们需要在本地PC安装N2N组网软件。您既可以选择源码编译方式安装，也可以选择下载编译后的程序直接使用，在这里我们用已经编译好的客户端软件做示范。下载程序，以管理员权限安装TAP适配器驱动，然后打开客户端并填写必要参数，如下图所示：</p>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2019/05/16/5cdd2ba3a75ef79552.png" alt="n2n_win.png" loading="lazy"></figure>
<p>对于服务器地址和端口，可以采用网络的免费的服务器，也可以选择自建服务器。本地IP是您所想要使用的虚拟IP，组名和密码决定了您与其他设备能否处于同一网络内。服务器版本需要和客户端版本一致，否则无法连接。附加参数我们需要勾选<code>-r</code>参数以开启流量转发功能。填写完毕后，启动软件便可以连接了。</p>
<h3 id="远程网关">远程网关</h3>
<p>其次我们还需要在远端路由网关安装N2N客户端。</p>
<h4 id="openwrt硬路由型网关">OpenWrt硬路由型网关</h4>
<p>如何安装N2N我们不再赘述，安装完成后，编辑配置文件如下：<code>cat /etc/config/n2n_v2</code></p>
<pre><code>config edge
	option enabled      '1'
	option tunname      'n2n'
	option mode         'static'
	option ipaddr		'10.10.10.100'
	option netmask      '255.255.255.0'
	option supernode	'你的服务器IP'
	option port         '7654'
	option community	'组名'
	option key          '密码'
	option route		'1'

</code></pre>
<p>然后我们需要编辑OpenWrt的防火墙规则，执行如下脚本以开启防火墙通道和IP伪装（SNAT）功能。</p>
<pre><code>#!/bin/sh
n2n_v2=$(ifconfig | grep n2n | awk '{print $1}')
iptables -D FORWARD -i $n2n_v2 -j ACCEPT 2&gt;/dev/null
iptables -D FORWARD -o $n2n_v2 -j ACCEPT 2&gt;/dev/null
iptables -t nat -D POSTROUTING -o $n2n_v2 -j MASQUERADE 2&gt;/dev/null
iptables -I FORWARD -i $n2n_v2 -j ACCEPT
iptables -I FORWARD -o $n2n_v2 -j ACCEPT
iptables -t nat -I POSTROUTING -o $n2n_v2 -j MASQUERADE
ip_segment=$(ip route | grep &quot;dev $n2n_v2 proto&quot; | awk '{print $1}')
iptables -t nat -I POSTROUTING -s $ip_segment -j MASQUERADE
</code></pre>
<p>然后运行程序<code>/etc/init.d/n2n_v2 start</code>即可连接到服务器。此时本地PC已经可以访问到网关的虚拟IP<code>10.10.10.100</code>，如下图所示：</p>
<figure data-type="image" tabindex="4"><img src="https://i.loli.net/2019/05/16/5cdd45d2692f610460.png" alt="100.png" loading="lazy"></figure>
<p>但是不能ping通网关的真实IP<code>192.168.1.254</code>，如下图所示：</p>
<figure data-type="image" tabindex="5"><img src="https://i.loli.net/2019/05/16/5cdd46c3ef01956073.png" alt="254timeout.png" loading="lazy"></figure>
<p>这是因为本地PC还没有指向192.168.1.0网段的路由，因此我们需要手动添加路由表。</p>
<pre><code>route add 192.168.1.0 mask 255.255.255.0 远程网关虚拟IP
</code></pre>
<p>例如<code>route add 192.168.1.0 mask 255.255.255.0 10.10.10.100</code>，注意添加路由表需要管理员权限。这时我们再访问网关以及网关的下属设备，就可以畅通无阻，如下图所示：</p>
<figure data-type="image" tabindex="6"><img src="https://i.loli.net/2019/05/16/5cdd2ba38610561126.png" alt="jieguo.png" loading="lazy"></figure>
<h4 id="windows软路由型网关">Windows软路由型网关</h4>
<p>有的工业设备是使用Windows作为路由使用的，这种情况下，需要开启Windows的路由和远程访问（Routing and Remote Access）服务，以管理员权限运行如下命令即可：</p>
<pre><code>sc config remoteaccess start=auto
sc start remoteaccess
</code></pre>
<p>然后将软路由的两个网口一个设置为固定IP地址作为LAN，而另一个则为WAN口接入互联网，接着按照在本地PC配置N2N的方式进行配置即可。当然了，要想访问到软路由及其下属设备，也需要同样的在本地PC添加路由表。</p>
<h2 id="总结">总结</h2>
<p>N2N的使用只需要简单的填写几个参数即可快速实现异地网络互连，使用简单方便。相对于传统的OpenVPN方案而言，不仅节省了服务器的开支，而且搭建方便，支持平台广泛，灵活性高，大大提高了企业运维人员的工作效率。</p>
</span></p></div>
	<br>
	<hr>
<div style="color: #ccc;font-size:14px;"><i class="fa fa-user"></i>本文由<a rel="license" href="/">郭玉超</a>创作</div>	
<div style="color: #ccc;font-size:14px;"><i class="fa fa-cc"></i>该文章采用<a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可。转载请注明出处！</div>
<div style="color: #ccc;font-size:14px;"><i class="fa fa-clock-o"></i>发布时间为：2019-06-06</div>    
	 <p class="md_block">
    <div class="reward"><div class="reward-button">赏 <span class="reward-code"> <span class="alipay-code"> <img class="alipay-img" src="https://ihidchaos.github.io/media/images/alipay.png"><b>支付宝扫码打赏</b> </span> <span class="wechat-code"> <img class="wechat-img" src="https://ihidchaos.github.io/media/images/wechat.png"><b>微信打赏</b> </span> </span></div></div>
<div style="text-align:center;color: #ccc;font-size:14px;">如果觉得这篇文章对您有帮助，可以请作者喝一杯饮料哦🥤</div>    
</p> 
</div>
</div>

<style type="text/css">
#mememe {
	border:3px;
	border-radius:5px;
    background-repeat: no-repeat;
    height: 100%;
	width: 100%;
	display: inline-block;
	border-radius:5px; 
}
</style>

<script>
var link = "" ;
$("img").each( (i,o) => {
	var o = $(o);
	if( o.attr("src").indexOf("sinaimg") > 0 || o.attr("src").indexOf("qpic") > 0 || o.attr("src").indexOf("baidu") > 0 || o.attr("src").indexOf("sinaimg") > 0){
		o.attr("referrerpolicy","no-referrer");
		link = o.attr("src");
		o.attr("src",link);
	}
});
</script>

<div style="width:100%;overflow:hidden">

          <div style="float:right;text-align:right;color:#ccc;font-size:18px;width:50%;">
            下一篇
            <a href="https://ihidchaos.github.io/post/hello-gridea/">
              <h3 class="post-title">
                Hello Gridea
              </h3>
            </a>
          </div>



          <div style="float:left;text-align:left;color:#ccc;font-size:18px;width:50%;">
            上一篇
            <a href="https://ihidchaos.github.io/post/shell_json/">
              <h3 class="post-title">
                Shell处理Json
              </h3>
            </a>
          </div>

</div>

<div class="doc_comments">

</div>

  </div>
</div>


      </div>
<div class="toc-container">
<ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%94%A8%E6%88%B7%E9%9C%80%E6%B1%82">用户需求</a></li>
<li><a href="#%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84">拓扑结构</a></li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">工作原理</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B">解决过程</a>
<ul>
<li><a href="#%E6%9C%AC%E5%9C%B0pc">本地PC</a></li>
<li><a href="#%E8%BF%9C%E7%A8%8B%E7%BD%91%E5%85%B3">远程网关</a>
<ul>
<li><a href="#openwrt%E7%A1%AC%E8%B7%AF%E7%94%B1%E5%9E%8B%E7%BD%91%E5%85%B3">OpenWrt硬路由型网关</a></li>
<li><a href="#windows%E8%BD%AF%E8%B7%AF%E7%94%B1%E5%9E%8B%E7%BD%91%E5%85%B3">Windows软路由型网关</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
</li>
</ul>

</div>
    </div>
	
   <div class="footer">
<div class="site_footer_wrap"><div class="site_footer">

      <div class="mysocials"><div class="my_socials">
		   
			   
    
			   
    
			   
    
			   
    
			   
    
			   
    
</div>
      </div>

      <div class="copyright" id="copyright">
	  <script>
		var date=new Date;
		var year=date.getFullYear(); 
		document.write("Copyright © "+year+" " + "郭玉超. ");
		</script>
		Powered by Gridea.
		<br>
		本站已稳定运行了
		<strong><script type="text/javascript">
		var urodz= new Date("10/28/2018");
		var now = new Date();
		var ile = now.getTime() - urodz.getTime();
		var dni = Math.floor(ile / (1000 * 60 * 60 * 24));
		document.write(+dni)
		</script>
		</strong>天
		<br>
		本站总访问量为 <strong><span id="busuanzi_value_site_uv"></span></strong> 次
	  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
      </div>
	  <img src="https://ihidchaos.github.io/media/images/font.svg">

    </div>

<script type="text/javascript" src="https://ihidchaos.github.io/media/scripts/love.js"></script>
<script type="text/javascript" src="https://ihidchaos.github.io/media/scripts/darkmode.js"></script>
<script>
var options = {
  bottom: '64px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: false, // default: true,
  label: '🌓', // default: ''
  autoMatchOsTheme: true // default: true
}

const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<script>
hljs.initHighlightingOnLoad();
</script>

</body>

</html>
